## 8章

### 8-1 小程序渲染层与逻辑层交互原理

网页开发 vs 小程序开发



|     | 网页开发  | 小程序开发 |
|  ----  | ----  |----  |
|  结构  | HTML | WXML |
|  样式  | CSS  | WSXX  |
|  逻辑  | JavaScript  | JavaScript |
|  DOM操作  | DOM API  | 无 |
|  BOM操作  | BOM API  | 无 |
|  渲染层和逻辑层  | 单线程，互斥  | 在不同线程中，分开  |
|  环境  | IE、chorme 等各种浏览器  | ios、android 的微信客户端  + 小程序开发者工具 |
|  开发过程  | vscode等编辑器+浏览器  | 申请小程序帐号、安装小程序开发者工具、配置项目等等过程  |


小程序中三大运行环境也是有所区别的。


|运行环境	|逻辑层	|渲染层|
|  ----  | ----  |----  |
|iOS	|JavaScriptCore	|WKWebView|
|安卓	|V8	|chromium定制内核|
|小程序开发者工具|	NWJS	|Chrome WebView |


总结，按照以下5个方面来讲：

1. 开发工具
	
		网页开发者在开发网页的时候，只需要使用到浏览器，并且搭配上一些辅助工具或者编辑器即可。
		小程序的开发则有所不同，需要经过申请小程序帐号、安装小程序开发者工具、配置项目等等过程方可完成。
	​
2. 运行环境
	
		网页开发者需要面对的环境是各式各样的浏览器，PC 端需要面对 IE、Chrome、QQ浏览器等，在移动端需要面对Safari、Chrome以及 iOS、Android 系统中的各式 WebView 。
		而小程序开发过程中需要面对的是两大操作系统 iOS 和 Android 的微信客户端，以及用于辅助开发的小程序开发者工具
		
3. 语法（html、css、js）
	
		HTML | WXML 
		CSS  | WSXX 
		JavaScript  | JavaScript
			
4. 单线程和多线程
	
		网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，
		而在小程序中，二者是分开的，分别运行在不同的线程中。
		小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了WebView 进行渲染；逻辑层采用JsCore线程运行JS脚本。
		
5. 双线程导致的无法直接操作dom、bom


		而如上文所述，小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，
		并没有一个完整浏览器对象，因而缺少相关的DOM API和BOM API。



渲染页面的技术选型：
	
	纯客户端元生技术，Android 和 iOS
	纯web技术，浏览器
	用客户端原生技术 与 web技术结合的混合技术（hybrid）





小程序宿主环境

![img](https://res.wx.qq.com/wxdoc/dist/assets/img/4-1.ad156d1c.png)



首先，我们来简单了解下小程序的运行环境。小程序的运行环境分成渲染层和逻辑层，其中 WXML 模板和 WXSS 样式工作在渲染层，JS 脚本工作在逻辑层。

小程序的渲染层和逻辑层分别由2个线程管理：
渲染层的界面使用了WebView 进行渲染；逻辑层采用JsCore线程运行JS脚本。	
一个小程序存在多个界面，所以渲染层存在多个WebView线程，		
这两个线程的通信会经由微信客户端（下文中也会采用Native来代指微信客户端）做中转，逻辑层发送网络请求也经由Native转发，小程序的通信模型下图所示。





> native （系统层）做了哪些工作？

JSBridge：在页面上通过JSBridge 调用微信一些能力


微信能力： 

	定位、扫码
	离线存储
	网咯请求
	运动步数
	地里位置

给页面上 count, 点击 ++ 如何交互的?

	给页面元素绑定事件，触发事件时，渲染层传递给 系统层
	
	系统层转发给逻辑层
	
	逻辑层 操作完，将 数据 返回给系统层
	
	系统层把数据传递给 渲染层，用于展示
	
	所以，很忌讳频繁的操作 setData，会卡死
	
	如果数据不在 渲染层 展示，不需要定义在data 中



### 	8-2 小程序运行机制与更新机制

[官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/operating-mechanism.html)

冷启动与热启动
前台与后台
小程序销毁
	退到后台，小程序会有一段存活时间，一般是5分钟，5分钟后销毁
	

#### 前台/后台状态		
小程序启动后，界面被展示给用户，此时小程序处于前台状态。

当用户点击右上角胶囊按钮关闭小程序，或者按了设备 Home 键离开微信时，小程序并没有完全终止运行，而是进入了后台状态，小程序还可以运行一小段时间。

当用户再次进入微信或再次打开小程序，小程序又会从后台进入前台。但如果用户很久没有再进入小程序，或者系统资源紧张，小程序可能被销毁，即完全终止运行。

#### 小程序启动
这样，小程序启动可以分为两种情况，一种是冷启动，一种是热启动。

冷启动：如果用户首次打开，或小程序销毁后被用户再次打开，此时小程序需要重新加载启动，即冷启动。
热启动：如果用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时小程序并未被销毁，只是从后台状态进入前台状态，这个过程就是热启动。

#### 小程序销毁时机
通常，只有当小程序进入后台一定时间，或者系统资源占用过高，才会被销毁。具体而言包括以下几种情形：

当小程序进入后台，可以维持一小段时间的运行状态，如果这段时间内都未进入前台，小程序会被销毁。
当小程序占用系统资源过高，可能会被系统销毁或被微信客户端主动回收。
在 iOS 上，当微信客户端在一定时间间隔内连续收到系统内存告警时，会根据一定的策略，主动销毁小程序，并提示用户 「运行内存不足，请重新打开该小程序」。具体策略会持续进行调整优化。
建议小程序在必要时使用 wx.onMemoryWarning 监听内存告警事件，进行必要的内存清理。



###	8-3 小程序性能与体验优化
###	8-4 详解setData工作原理
###	8-5 场景值scene的作用与应用场景
###8-6 页面收录sitemap
###	8-7 小程序上线审核流程
